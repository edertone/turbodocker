# PHP 7, Apache 2.4 docker image with volume mounted virtual hosts support

This docker image contains a php + apache production ready server. After setting it up, we will obtain a fully operative web server with php runtime configured to use multiple independent virtualhosts, so we will be able to host several websites with a single docker container.

## Development documentation

- [Development, testing and deployment documentation](./docs/develop-test-publish.md)

## Features

  - Php 7.4.16
  - Apache 2.4.38
  - Php and apache configured for optimal performance
  - Virtualhosts ready to use: Host as many webistes as yu want with a single docker container
  - Unified logs for all the virtual hosts
  - Http and Https enabled
  
## Pre requisites

- An existing linux machine with docker installed (a VPS or dedicated server for example)

## Create the folders structure that will be mounted as a docker volume

Before running the docker container, we must create a structure of folders that will be used to setup the virtual hosts and provide the files for their respective websites. This structure will be read by the docker container to feed the php and apache services.

A single user approach is used: All the folders and files must be owned by www-data which is the apache server user, except the root one which will be owned by root. **Remember this when uploading files to your server. If you need to use different sftp users to upload the websites, you can use bindfs to mount their home folders to their respective virtualhosts htdocs folder so all the files keep being www-data owned, but this technique is not covered here**. Be careful also when operating with the websites cause there is no isolation between the virtualhosts, everything is managed by the same user (www-data). This is a limitation but also a simplification. Let's create the required folders and files:

  - Create a folder **/usr/docker-persistent** (owned by root)

  - Create a folder **/usr/docker-persistent/virtualhosts** (owned by www-data)
 
  - Create a folder **/usr/docker-persistent/virtualhosts/.logs** (owned by www-data). It will contain the logs generated by the virtual hosts, apache and php. you can delete the logs at any time if you need to make space. They will be automaticall regenerated
 
  - Create one folder for each virtualhost you want to use, using reverse domain notation:

    - **/usr/docker-persistent/virtualhosts/com_domain** (owned by www-data). With the following contents:
  	      
      - **htdocs** Folder where the web files must be placed, basically the root www folder for that domain.
      - **com_domain.conf** File with the apache configuration for this specific virtualhost:

```
<VirtualHost *:80>
	ServerName domain.com
	DocumentRoot /var/www/virtualhosts/com_domain/htdocs
</VirtualHost>

<IfModule mod_ssl.c>
	<VirtualHost *:443>
		ServerName domain.com
		DocumentRoot /var/www/virtualhosts/com_domain/htdocs
		SSLEngine on
		SSLCertificateFile /var/www/certificates/localhost.crt
		SSLCertificateKeyFile /var/www/certificates/localhost.key
	</VirtualHost>
</IfModule>
```

## Run the docker image

Now that we have setup all the data to run our websites, it is time to launch the docker image that will be used to render them. Move into linux cmd and run the following command:
```
docker run --name=php7-apache-vhosts --restart always -d -p 80:80 -p 443:443 -v /usr/docker-persistent/virtualhosts:/var/www/virtualhosts edertone/php7-apache-vhosts:latest
```

This will launch a docker container that will respawn automatically if your system reboots, with a volume mounted to the /usr/docker-persistent/virtualhosts folder and using standard http 80 and https 443 ports (your websites should be visible now via http and https).
  
## Apendix: Useful docker cmd commands

Here's a list of docker commands to interact with this image:

  - **Update the local image and running container with the latest on repository and restart**
    
	```
	docker stop php7-apache-vhosts
	docker rm php7-apache-vhosts
	docker pull edertone/php7-apache-vhosts:latest
	docker run --name=php7-apache-vhosts --restart always -d -p 80:80 -p 443:443 -v /usr/docker-persistent/virtualhosts:/var/www/virtualhosts edertone/php7-apache-vhosts:latest
    ```
    	
  - **Restart the running container**
  
    `docker restart php7-apache-vhosts`
	
  - **Access the bash for the docker container to directly run cmd commands inside it**
  
    `docker exec -it php7-apache-vhosts bash`
	
  - **Refresh all the virtualhosts when a new one is added or removed** (must be called inside the container bash)
  
	`/usr/local/bin/startup.sh`
